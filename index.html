<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 交互助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.12/marked.min.js"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 flex justify-center items-center min-h-screen">
    <div class="w-full max-w-3xl bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">AI 交互助手</h2>
            <button onclick="toggleDarkMode()" class="px-2 py-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-md">🌙</button>
        </div>
        <div id="chatbox" class="h-[500px] overflow-y-auto border p-4 bg-gray-50 dark:bg-gray-700 rounded-lg mb-4 space-y-2" onscroll="loadMoreMessages()"></div>
        <div class="flex space-x-2">
            <input id="userInput" type="text" class="flex-1 p-2 border rounded-lg dark:bg-gray-600 dark:text-white" placeholder="请输入您的问题..." onkeypress="handleKeyPress(event)">
            <button onclick="sendMessage()" class="px-4 py-2 bg-blue-500 text-white rounded-lg">发送</button>
        </div>
        <p class="text-sm text-gray-500 dark:text-gray-300 mt-2">AI 互动界面采用 ChatGPT 4.0，界面尚不完善，输出仅供参考。</p>
    </div>

    <script>
        const API_KEY = "sk-ocyVjypZVQYI4JzmpcbfKvzB27u8ERxJBYnkcp8psvCAqCVM";
        const BASE_URL = "https://cn.gptapi.asia/v1/chat/completions";
        let chatHistory = [];
        let isLoading = false;

        async function sendMessage() {
            const inputField = document.getElementById("userInput");
            const chatbox = document.getElementById("chatbox");
            const userMessage = inputField.value.trim();
            if (!userMessage) return;

            appendMessage("user", userMessage);
            inputField.value = "";

            const loadingIndicator = appendMessage("ai", "🤖 AI 正在输入...");

            try {
                const res = await fetch(BASE_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${API_KEY}`,
                    },
                    body: JSON.stringify({
                        model: "gpt-4",
                        messages: [{ role: "user", content: userMessage }],
                    }),
                });

                const data = await res.json();
                const aiResponse = data.choices?.[0]?.message?.content || "无响应";
                loadingIndicator.remove();
                appendMessage("ai", aiResponse);
            } catch (error) {
                loadingIndicator.remove();
                appendMessage("ai", "请求失败，请检查 API 设置");
            }
        }

        function appendMessage(role, text) {
            const chatbox = document.getElementById("chatbox");
            const messageDiv = document.createElement("div");
            messageDiv.classList.add("p-2", "rounded-lg", "max-w-2xl", "animate-fadeIn");
            
            if (role === "user") {
                messageDiv.classList.add("bg-blue-500", "text-white", "self-end", "ml-auto");
            } else {
                messageDiv.classList.add("bg-gray-300", "text-black", "self-start", "mr-auto");
                messageDiv.innerHTML = marked.parse(text); // Markdown 渲染
            }
            
            messageDiv.innerHTML = text;
            chatbox.appendChild(messageDiv);
            chatbox.scrollTop = chatbox.scrollHeight;
            chatHistory.push({ role, text });
            return messageDiv;
        }

        function handleKeyPress(event) {
            if (event.key === "Enter") {
                sendMessage();
            }
        }

        function toggleDarkMode() {
            document.body.classList.toggle("dark");
        }

        function loadMoreMessages() {
            const chatbox = document.getElementById("chatbox");
            if (chatbox.scrollTop === 0 && !isLoading) {
                isLoading = true;
                setTimeout(() => {
                    const previousMessages = chatHistory.slice(0, 5); // 加载更多历史消息
                    previousMessages.forEach(msg => appendMessage(msg.role, msg.text));
                    isLoading = false;
                }, 1000);
            }
        }
    </script>
</body>
</html>
